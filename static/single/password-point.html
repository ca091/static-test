<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>图片密码解锁</title>
  <style>
    .box-error {
      width: 10px;
      height: 10px;
      background-color: red;
    }

    .box-picture {
      width: 300px;
      height: 300px;
      margin: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      background: url("../asset/image/2111540456957_.pic.jpg") center no-repeat;
      background-size: cover;
    }

    .box-picture .message {
      transform: scale(0);
      font-size: 16px;
    }

    .box-picture .success {
      transition: transform 1.8s ease-out;
      color: green;
      transform: scale(3);
    }

    .box-picture .fail {
      transition: transform 1.8s ease-out;
      color: red;
      transform: scale(3);
    }
  </style>
</head>
<body>
<p id="msg">click picture to set password (4 point)</p>
<div class="box-picture">
  <p id="unlock-message" class="message">success</p>
</div>
<p>允许误差大小</p>
<div class="box-error"></div>
<script>
  // 允许误差
  const error = 5
  let setPass = {
    points: [],
    isSet: true,
  }
  let unlocks = {
    points: [],
    status: true,
  }
  let el_box_picture = document.querySelector('.box-picture')
  let el_msg = document.querySelector('#msg')
  let el_unlock_message = document.querySelector('#unlock-message')

  el_unlock_message.addEventListener('transitionend', e => {
    el_unlock_message.className = 'message'
    unlocks.points = [...setPass.points]
    unlocks.status = true
  })

  el_box_picture.addEventListener('click', e => {
    let x = e.offsetX
    let y = e.offsetY
    if (setPass.isSet) {
      setPoints({x, y}, setPointsCallback)
    } else {
      unlock({x, y}, unlockCallback)
    }
  })

  // 设置过程
  function setPoints({x, y}, callback) {
    if (setPass.points.length < 4) {
      setPass.points.push({x, y})
      callback()
    }
  }

  // 设置完成回调
  function setPointsCallback() {
    // 设置完成
    if (setPass.points.length === 4) {
      setPass.isSet = false
      el_msg.textContent = 'click picture to unlock (4 point)'
      unlocks.points = [...setPass.points]
      console.log(unlocks)
    }
  }

  // 解锁完成回调
  function unlockCallback() {
    // 解锁完成
    if (unlocks.points.length === 0) {
      if (unlocks.status) {
        el_unlock_message.textContent = 'success'
        el_unlock_message.className = 'message success'
      } else {
        el_unlock_message.textContent = 'fail'
        el_unlock_message.className = 'message fail'
      }
    }
  }

  // 解锁过程
  function unlock({x, y}, fn) {
    let point = unlocks.points.shift()
    if (point) {
      if ((point.x - error < x && x < point.x + error) &&
        (point.y - error < y && y < point.y + error)) {
      } else {
        unlocks.status = false
      }
      fn()
    }
  }
</script>
</body>
</html>
